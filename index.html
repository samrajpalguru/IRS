<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IRIS Scan</title>
    <style>
        /* Your existing CSS styles */
    </style>
     <script src="jquery-1.8.2.js"></script>
     <script src="miscan.js"></script>
     <script language="javascript" type="text/javascript">
         UnInit();
         var timeout = 50; // seconds (minimum=10(recommanded), maximum=60, unlimited=0 )
         var nooffinger = '1';
         $(document).ready(function () {
             UnInit();
             ClearData();
         });

         function ClearData() {
             document.getElementById('tdSerial').innerHTML = "";
             document.getElementById('tdMake').innerHTML = "";
             document.getElementById('tdModel').innerHTML = "";
             document.getElementById('tdWidth').innerHTML = "";
             document.getElementById('tdHeight').innerHTML = "";
             document.getElementById('tdSystemID').innerHTML = "";
             document.getElementById('txtImageInfo').value = "";
             document.getElementById('txtIsoTemplate').value = "";
             document.getElementById('imgFinger').src = "";
             document.getElementById('txtStatus').value = "";
         }

         function validate() {
             timeout = $("#txtTimeout").val();
             if (timeout == "") {
                 alert("Timeout must not be null");
                 return false;
             }
             if (timeout > 9 && timeout % 1 == 0) {}
             else {
                 alert("Invalid timeout or timeout should be greater or equal to 10");
                 return false;
             }
             return true;
         }

         function GetInfo() {
             DisabledButton(true)
             document.getElementById('tdSerial').innerHTML = "";
             document.getElementById('tdMake').innerHTML = "";
             document.getElementById('tdModel').innerHTML = "";
             document.getElementById('tdWidth').innerHTML = "";
             document.getElementById('tdHeight').innerHTML = "";
             document.getElementById('tdSystemID').innerHTML = "";
             document.getElementById('txtStatus').value = "";
             document.getElementById('imgFinger').src = "data:image/bmp;base64,";
             document.getElementById('txtImageInfo').value = "";
             document.getElementById('txtIsoTemplate').value = "";
             var res;
             res = GetMIScanInfo();
             if (res.httpStaus) {
                 document.getElementById('txtStatus').value = "ErrorCode: " + res.data.ErrorCode + " ErrorDescription: " + res.data.ErrorDescription;
                 if (res.data.ErrorCode == "0") {
                     isInit = 1;
                     document.getElementById('tdSerial').innerHTML = res.data.DeviceInfo1.SerialNo;
                     document.getElementById('tdMake').innerHTML = res.data.DeviceInfo1.Make;
                     document.getElementById('tdModel').innerHTML = res.data.DeviceInfo1.Model;
                     document.getElementById('tdWidth').innerHTML = res.data.DeviceInfo1.Width;
                     document.getElementById('tdHeight').innerHTML = res.data.DeviceInfo1.Height;
                     document.getElementById('tdSystemID').innerHTML = res.data.DeviceInfo1.SystemID;
                 }
             }
             else {
                 alert(res.err);
             }
             DisabledButton(false);
             return false;
         }

         var delayInMilliseconds = 300; //0.1 second
         var isInit = 0;
         function Capture() {
             try {
                 DisabledButton(true);
                 document.getElementById('txtStatus').value = "";
                 document.getElementById('imgFinger').src = "";
                 document.getElementById('txtImageInfo').value = "";
                 document.getElementById('txtIsoTemplate').value = "";
                 if (!validate()) {
                 }
                 else {
                     if (isInit == 1) {
                         document.getElementById('txtStatus').value = "Capture is in progress......";
                     }
                     setTimeout(function () {
                         timeout = $("#txtTimeout").val();
                         if (timeout == "") {
                             alert("Timeout must not be null");
                             DisabledButton(false);
                             return false;
                         }
                         if (timeout >= 0 && timeout % 1 == 0) {}
                         else {
                             alert("Invalid timeout or timeout should be greater or equal to 10");
                             DisabledButton(false);
                             return false;
                         }

                         var res = CaptureIris(timeout);
                         if (res.httpStaus) {
                             if (res.data.ErrorCode == "0") {
                                 document.getElementById('imgFinger').src = "data:image/bmp;base64," + res.data.BitmapData;
                                 var imageinfo = "Quality: " + res.data.Quality;
                                 document.getElementById('txtImageInfo').value = imageinfo;
                                 document.getElementById('txtStatus').value = "ErrorCode: " + res.data.ErrorCode + " ErrorDescription: " + "Capture Success";
                             }
                             else {
                                 document.getElementById('txtStatus').value = "ErrorCode: " + res.data.ErrorCode + " ErrorDescription: " + res.data.ErrorDescription;
                                 alert(res.data.ErrorDescription);
                             }
                         }
                         else {
                             document.getElementById('txtStatus').value = "ErrorCode: " + res.data.ErrorCode + " ErrorDescription: " + res.data.ErrorDescription;
                             alert(res.err);
                         }

                         DisabledButton(false);

                     }, delayInMilliseconds);
                 }
             }
             catch (e) {
                 document.getElementById('txtStatus').value = "ErrorCode: " + res.data.ErrorCode + " ErrorDescription: " + "";
                 alert(e);
             }
             return false;
         }

         function DisabledButton(isDisabled) {
             $('#btnCapture').prop('disabled', isDisabled);
             $('#btnInfo').prop('disabled', isDisabled);
         }

         // New function to save the image
         function saveImage() {
             const imgSrc = document.getElementById('imgFinger').src;  // Get the image source
             if (imgSrc) {
                 const link = document.createElement('a');
                 link.href = imgSrc;
                 link.download = 'iris_image.bmp';  // Set the filename to be saved
                 link.click();  // Trigger the download
             } else {
                 alert("No image to save.");
             }
         }

     </script>
</head>
<body>
    <div class="panel">
   
    <div class="header">IRIS Scan</div>
    <div class="body_wrapper">
        <div class="wrapper_item">
            <div class="wrapper_item_box" style="width:2700px">
                <div class="flex_box">
                    <div class="input-group">
                        <label>Timeout</label>
                        <input type="text" class="form-control" id="txtTimeout" value="10" />
                    </div>
                    <div class="input-group">
                        <label>Select Image Type</label>
                        <select id="ddlImageFormat" class="form-control">
                            <option value="0">Select</option>
                            <option value="1">BMP</option>
                        </select>
                    </div>
                </div>
                <div class="button-group">
                    <input type="submit" id="btnInfo" value="Get Info" class="btn btn-primary btn-200" onclick="return GetInfo()" />
                    <input type="submit" id="btnCapture" value="Capture" class="btn btn-primary btn-200" onclick="return Capture()" />
                </div>
            </div>
            <div class="wrapper_item_box img_box">
                <img id="imgFinger" style=" border: 1px solid #AEAEAE;" width="250px" height="190px" alt="Iris Image" />
            </div>
            <div class="wrapper_item_box">
                <div class="button-group">
                    <!-- New Save Image Button -->
                    <button class="btn btn-primary btn-200" onclick="saveImage()">Save Image</button>
                </div>
            </div>
            <div class="wrapper_item_box">
                <div class="details">
                        <span class="text-bold">Serial No:</span>
                        <span id="tdSerial"></span>
                    </div>
                    <div class="details">
                        <span class="text-bold">Make:</span>
                        <span id="tdMake"></span>
                    </div>
                    <div class="details">
                        <span class="text-bold">Model:</span>
                        <span id="tdModel"></span>
                    </div>
                    <div class="details">
                        <span class="text-bold">Width:</span>
                        <span id="tdWidth"></span>
                    </div>
                    <div class="details">
                        <span class="text-bold">Height:</span>
                        <span id="tdHeight"></span>
                    </div>
                    <div class="details">
                        <span class="text-bold">System ID:</span>
                        <span id="tdSystemID"></span>
                    </div>
                </div>
        </div>
    </div>
    </div>
</body>
</html>
